{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/docs.css') }}">
{% endblock %}

{% block content %}
<div class="docs-layout">
    
    <!-- SIDEBAR NAVIGATION -->
    <aside class="docs-sidebar">
        <h3>General</h3>
        <ul>
            <li><a href="#protocol" class="active">Protocol</a></li>
            <li><a href="#auth">Authentication</a></li>
            <li><a href="#db-mgmt">Database Mgmt</a></li>
        </ul>

        <h3>Schema (DDL)</h3>
        <ul>
            <li><a href="#types">Data Types</a></li>
            <li><a href="#create-table">Create Table</a></li>
            <li><a href="#foreign-keys">Foreign Keys</a></li>
            <li><a href="#drop-table">Drop Table</a></li>
        </ul>

        <h3>Data (DML)</h3>
        <ul>
            <li><a href="#insert">Insert</a></li>
            <li><a href="#update">Update</a></li>
            <li><a href="#delete">Delete</a></li>
            <li><a href="#select">Select</a></li>
        </ul>

        <h3>System</h3>
        <ul>
            <li><a href="#backup">Backup & Restore</a></li>
        </ul>
    </aside>

    <!-- MAIN DOCUMENTATION CONTENT -->
    <main class="docs-content">
        
        <section id="intro">
            <h1>MaazDB Documentation</h1>
            <p><strong>Version:</strong> {{ version }}<br>
            <strong>Default Port:</strong> 8888<br>
            <strong>Protocol:</strong> TCP / Binary Length-Prefixed</p>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 2rem 0;">
        </section>

        <!-- 1. PROTOCOL -->
        <section id="protocol">
            <h2>1. Connection Protocol</h2>
            <p>MaazDB uses a custom binary protocol. Every packet follows this structure:</p>
            <table>
                <thead><tr><th>Byte</th><th>Field</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>1</td><td>Type</td><td><code>0x01</code> Command, <code>0x02</code> Msg, <code>0x03</code> Data, <code>0xFF</code> Error</td></tr>
                    <tr><td>4</td><td>Length</td><td>Unsigned 32-bit Integer (Big-Endian)</td></tr>
                    <tr><td>N</td><td>Payload</td><td>UTF-8 String (SQL or JSON Result)</td></tr>
                </tbody>
            </table>
        </section>

        <!-- 2. AUTHENTICATION -->
        <section id="auth">
            <h2>2. Authentication</h2>
            
            <h3>Login</h3>
            <p>Authenticates the current session. Must be the first command sent.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>LOGIN &lt;username&gt; PASSWORD '&lt;password&gt;';</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>LOGIN admin PASSWORD 'admin';</code></pre>

            <h3>Create User</h3>
            <p>Registers a new user in the system.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>CREATE USER &lt;username&gt; PASSWORD '&lt;password&gt;';</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>CREATE USER john PASSWORD 'secret123';</code></pre>
        </section>

        <!-- 3. DATABASE MANAGEMENT -->
        <section id="db-mgmt">
            <h2>3. Database Management</h2>

            <h3>Create Database</h3>
            <span class="code-label">Syntax</span>
            <pre><code>CREATE DATABASE &lt;db_name&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>CREATE DATABASE shop_db;</code></pre>

            <h3>Use Database</h3>
            <p>Selects the active database for subsequent queries.</p>
            <span class="code-label">Syntax</span>
            <pre><code>USE &lt;db_name&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>USE shop_db;</code></pre>

            <h3>Drop Database</h3>
            <span class="code-label">Syntax</span>
            <pre><code>DROP DATABASE &lt;db_name&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>DROP DATABASE shop_db;</code></pre>
        </section>

        <!-- 4. SCHEMA (DDL) -->
        <section id="types">
            <h2>4. Schema Definition (DDL)</h2>
            <h3>Supported Data Types</h3>
            <table>
                <thead><tr><th>Type</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><code>SERIAL</code></td><td>Auto-incrementing Integer (Primary Key only)</td></tr>
                    <tr><td><code>INT</code></td><td>Standard 32-bit Integer</td></tr>
                    <tr><td><code>DOUBLE</code></td><td>64-bit Floating point</td></tr>
                    <tr><td><code>TEXT</code></td><td>UTF-8 String</td></tr>
                    <tr><td><code>BOOL</code></td><td>Boolean (TRUE/FALSE)</td></tr>
                    <tr><td><code>TIMESTAMP</code></td><td>Format: 'YYYY-MM-DD HH:MM:SS'</td></tr>
                </tbody>
            </table>
        </section>

        <section id="create-table">
            <h3>Create Table</h3>
            <p>Defines a new table structure.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>CREATE TABLE &lt;table_name&gt; (
    &lt;col_name&gt; &lt;type&gt; [PRIMARY KEY],
    &lt;col_name&gt; &lt;type&gt;,
    ...
);</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    age INT,
    salary DOUBLE,
    active BOOL
);</code></pre>
        </section>

        <section id="foreign-keys">
            <h3>Foreign Keys</h3>
            <p>Enforces referential integrity between tables.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>CREATE TABLE &lt;table_name&gt; (
    ...
    FOREIGN KEY (&lt;local_col&gt;) REFERENCES &lt;parent_table&gt;(&lt;parent_col&gt;)
);</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INT,
    amount DOUBLE,
    FOREIGN KEY (user_id) REFERENCES users(id)
);</code></pre>
        </section>

        <section id="drop-table">
            <h3>Drop Table</h3>
            <span class="code-label">Syntax</span>
            <pre><code>DROP TABLE &lt;table_name&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>DROP TABLE users;</code></pre>
        </section>

        <!-- 5. DATA MANIPULATION (DML) -->
        <section id="insert">
            <h2>5. Data Manipulation (DML)</h2>
            
            <h3>Insert</h3>
            <p>Adds new rows. Do not include <code>SERIAL</code> columns.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>INSERT INTO &lt;table_name&gt; (&lt;col1&gt;, &lt;col2&gt;) VALUES (&lt;val1&gt;, &lt;val2&gt;);</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>INSERT INTO users (name, age, active) VALUES ('Alice', 30, TRUE);</code></pre>
        </section>

        <section id="update">
            <h3>Update</h3>
            <p>Modifies existing data based on a condition.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>UPDATE &lt;table_name&gt; SET &lt;col&gt; = &lt;val&gt; WHERE &lt;condition&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>UPDATE users SET salary = 55000.00 WHERE name = 'Alice';</code></pre>
        </section>

        <section id="delete">
            <h3>Delete</h3>
            <p>Removes rows based on a condition.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>DELETE FROM &lt;table_name&gt; WHERE &lt;condition&gt;;</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>DELETE FROM users WHERE name = 'Charlie';</code></pre>
        </section>

        <section id="select">
            <h3>Select</h3>
            <p>Retrieves data. Supports <code>WHERE</code>, <code>ORDER BY</code>, <code>LIMIT</code>, and <code>OFFSET</code>.</p>
            
            <span class="code-label">Syntax</span>
            <pre><code>SELECT &lt;cols&gt; FROM &lt;table_name&gt; [WHERE condition] [ORDER BY col] [LIMIT n];</code></pre>
            
            <span class="code-label">Example 1 (Basic)</span>
            <pre><code>SELECT * FROM users WHERE age > 25;</code></pre>
            
            <span class="code-label">Example 2 (Complex)</span>
            <pre><code>SELECT name, salary FROM users 
WHERE active = TRUE 
ORDER BY salary DESC 
LIMIT 10;</code></pre>
        </section>

        <!-- 6. BACKUP & RESTORE -->
        <section id="backup">
            <h2>6. Disaster Recovery</h2>
            
            <h3>Backup</h3>
            <p>Creates a snapshot of the current database state.</p>
            <span class="code-label">Syntax</span>
            <pre><code>BACKUP '&lt;snapshot_name&gt;';</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>BACKUP 'snapshot_v1';</code></pre>

            <h3>Restore</h3>
            <p>Reverts database to a snapshot. <strong>Overwrites current data.</strong></p>
            <span class="code-label">Syntax</span>
            <pre><code>RESTORE '&lt;snapshot_name&gt;';</code></pre>
            
            <span class="code-label">Example</span>
            <pre><code>RESTORE 'snapshot_v1';</code></pre>
        </section>

    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Syntax Highlighting Logic
        const codeBlocks = document.querySelectorAll('pre code');
        
        const keywords = ['LOGIN', 'CREATE', 'DATABASE', 'USE', 'TABLE', 'DROP', 'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 'WHERE', 'DELETE', 'FROM', 'SELECT', 'ORDER', 'BY', 'LIMIT', 'OFFSET', 'BACKUP', 'RESTORE', 'PRIMARY', 'KEY', 'FOREIGN', 'REFERENCES', 'SERIAL', 'INT', 'DOUBLE', 'TEXT', 'BOOL', 'TIMESTAMP', 'PASSWORD', 'USER', 'AND', 'OR', 'NOT'];
        
        codeBlocks.forEach(block => {
            let html = block.innerHTML;
            
            // Highlight Keywords
            keywords.forEach(kw => {
                const regex = new RegExp(`\\b${kw}\\b`, 'gi');
                html = html.replace(regex, `<span class="sql-keyword">${kw}</span>`);
            });
            
            // Highlight Strings
            html = html.replace(/'([^']+)'/g, `<span class="sql-string">'$1'</span>`);
            
            // Highlight Numbers
            html = html.replace(/\b(\d+)\b/g, `<span class="sql-number">$1</span>`);
            
            block.innerHTML = html;
        });

        // 2. Scroll Spy for Sidebar
        const sidebarLinks = document.querySelectorAll('.docs-sidebar a');
        const sections = document.querySelectorAll('section[id]');

        window.addEventListener('scroll', () => {
            let current = '';
            const scrollY = window.scrollY + 100; // Offset

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop) {
                    current = section.getAttribute('id');
                }
            });

            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}